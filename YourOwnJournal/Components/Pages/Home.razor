@page "/"
@inject JournalService JournalService
@inject StreakService StreakService
@inject AnalyticsService AnalyticsService

<div class="card-soft">
    <div class="d-flex justify-content-between flex-wrap gap-3">
        <div>
            <div class="badge-soft">Overview</div>
            <h2 class="mt-2">Welcome back</h2>
            <div class="text-muted">Your journal highlights for the selected range.</div>
        </div>
        <div class="d-flex gap-2">
            <InputDate @bind-Value="StartDate" class="form-control" />
            <InputDate @bind-Value="EndDate" class="form-control" />
            <button class="btn btn-outline-primary" @onclick="ReloadAsync">Apply</button>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card-soft stat-card">
            <div class="text-muted">Total entries</div>
            <div class="stat-value">@TotalEntries</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-soft stat-card">
            <div class="text-muted">Current streak</div>
            <div class="stat-value">@CurrentStreak days</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-soft stat-card">
            <div class="text-muted">Longest streak</div>
            <div class="stat-value">@LongestStreak days</div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card-soft">
            <h5>Mood distribution</h5>
            @if (MoodCategories.Count == 0)
            {
                <div class="text-muted">No data yet.</div>
            }
            else
            {
                @foreach (var mood in MoodCategories)
                {
                    <div class="d-flex justify-content-between">
                        <span>@mood.Category</span>
                        <span>@mood.Count</span>
                    </div>
                    <div class="progress-track mb-2">
                        <div class="progress-bar" style="width: @GetPercent(mood.Count)%"></div>
                    </div>
                }
            }
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card-soft">
            <h5>Frequent moods</h5>
            @if (TopMoods.Count == 0)
            {
                <div class="text-muted">No mood data yet.</div>
            }
            else
            {
                @foreach (var mood in TopMoods.Take(6))
                {
                    <div class="d-flex justify-content-between">
                        <span>@mood.Name</span>
                        <span>@mood.Count</span>
                    </div>
                    <div class="progress-track mb-2">
                        <div class="progress-bar" style="width: @GetPercent(mood.Count, MaxTopMoodCount)%"></div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card-soft">
            <h5>Tag breakdown</h5>
            @if (TagUsage.Count == 0)
            {
                <div class="text-muted">No tags yet.</div>
            }
            else
            {
                @foreach (var tag in TagUsage.Take(8))
                {
                    <div class="d-flex justify-content-between">
                        <span>@tag.Name</span>
                        <span>@tag.Count</span>
                    </div>
                    <div class="progress-track mb-2">
                        <div class="progress-bar" style="width: @GetPercent(tag.Count, MaxTagCount)%"></div>
                    </div>
                }
            }
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card-soft">
            <h5>Word count trend</h5>
            @if (WordCountTrend.Count == 0)
            {
                <div class="text-muted">No entries in this range.</div>
            }
            else
            {
                @foreach (var point in WordCountTrend)
                {
                    <div class="d-flex justify-content-between">
                        <span>@point.Date.ToString("MMM dd")</span>
                        <span>@point.WordCount words</span>
                    </div>
                    <div class="progress-track mb-2">
                        <div class="progress-bar" style="width: @GetPercent(point.WordCount, MaxWordCount)%"></div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private DateTime StartDate { get; set; } = DateTime.Today.AddDays(-30);
    private DateTime EndDate { get; set; } = DateTime.Today;
    private int TotalEntries { get; set; }
    private int CurrentStreak { get; set; }
    private int LongestStreak { get; set; }
    private IReadOnlyList<CategoryCount> MoodCategories { get; set; } = new List<CategoryCount>();
    private IReadOnlyList<MoodCount> TopMoods { get; set; } = new List<MoodCount>();
    private IReadOnlyList<TagCount> TagUsage { get; set; } = new List<TagCount>();
    private IReadOnlyList<WordCountPoint> WordCountTrend { get; set; } = new List<WordCountPoint>();
    private int MaxMoodCount => MoodCategories.Count == 0 ? 1 : MoodCategories.Max(m => m.Count);
    private int MaxTopMoodCount => TopMoods.Count == 0 ? 1 : TopMoods.Max(m => m.Count);
    private int MaxTagCount => TagUsage.Count == 0 ? 1 : TagUsage.Max(t => t.Count);
    private int MaxWordCount => WordCountTrend.Count == 0 ? 1 : WordCountTrend.Max(w => w.WordCount);

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        TotalEntries = await JournalService.GetTotalCountAsync();
        CurrentStreak = await StreakService.GetCurrentStreakAsync();
        LongestStreak = await StreakService.GetLongestStreakAsync();
        MoodCategories = await AnalyticsService.GetMoodCategoryDistributionAsync(StartDate, EndDate);
        TopMoods = await AnalyticsService.GetTopMoodsAsync(StartDate, EndDate);
        TagUsage = await AnalyticsService.GetTagUsageAsync(StartDate, EndDate);
        WordCountTrend = await AnalyticsService.GetWordCountTrendAsync(StartDate, EndDate);
    }

    private int GetPercent(int count)
    {
        return (int)Math.Round(count / (double)MaxMoodCount * 100);
    }

    private int GetPercent(int count, int max)
    {
        return max <= 0 ? 0 : (int)Math.Round(count / (double)max * 100);
    }
}
